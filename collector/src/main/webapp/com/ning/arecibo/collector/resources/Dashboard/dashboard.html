<!DOCTYPE html>
<html>
<head>
    <title>Arecibo dashboard</title>
    <link href="/static/bootstrap-v1.4.0.min.css" rel="stylesheet">
    <link href="/static/addyosmani-jquery-ui-1.8.16.custom-v0.23-2.css" rel="stylesheet">
    <link href="/static/addyosmani-jquery-ui-bootstrap-daterangepicker-v0.23-2.css" rel="stylesheet">
    <style type="text/css">
        /* D3 */
        line {
          stroke: black;
        }

        path {
            fill: none;
            stroke: green;
        }

        /* DateTime picker */
        .ui-div .ui-widget-header { margin-bottom: 8px; }
        .ui-timepicker-div dl { text-align: left; }
        .ui-timepicker-div dl dt { height: 25px; margin-bottom: -25px; }
        .ui-timepicker-div dl dd { margin: 0 10px 10px 65px; }
        .ui-timepicker-div td { font-size: 90%; }
        .ui-tpicker-grid-label { background: none; border: none; margin: 0; padding: 0; }

        /* Misc. */
        .show-grid {
            text-align: center;
        }

        input#samples_start,
        input#samples_end,
        input.ui-autocomplete-input {
            color: white;
        }

        #errorDiv pre {
            background-color: transparent;
        }

        #graphs-grid {
            margin-top: 50px;
        }
    </style>

    <script type="text/javascript" src="/static/d3-v2.7.2.min.js"></script>
    <script type="text/javascript" src="/static/d3-v2.7.2.time.min.js"></script>
    <script type="text/javascript" src="/static/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/static/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap-dropdown-v1.4.0.js"></script>
    <script type="text/javascript" src="/static/jquery-ui-timepicker-addon-v0.9.8.js"></script>

    <script type="text/javascript">
        /* Prepare the Hosts menu */

        function findHosts() {
            $.ajax({
                url: "/rest/1.0/hosts",
                dataType: "jsonp",
                cache : false,
                jsonp : "callback",
                jsonpCallback: "populateHosts"
            });
        }

        function populateHosts(hosts) {
            //console.log(hosts);
            var hostsArray = [];
            $.each(hosts, function(id, host) {
                hostsArray.push(host);
            });
            $("#host_name").autocomplete({
                source: hostsArray
            });
        }

        /* Prepare the Sample kinds menu */

        function findSampleKinds() {
            $.ajax({
                url: "/rest/1.0/sample_kinds",
                dataType: "jsonp",
                cache : false,
                jsonp : "callback",
                jsonpCallback: "populateSampleKinds"
            });
        }

        function populateSampleKinds(sampleKinds) {
            //console.log(sampleKinds);
            var sampleKindsArray = [];
            $.each(sampleKinds, function(id, sampleKind) {
                sampleKindsArray.push(sampleKind);
            });
            $("#sample_kind").autocomplete({
                source: sampleKindsArray
            });
        }

        /* Prepare the date time picker */

        function setupDateTimePickers() {
            $('#samples_start').datetimepicker({
                hourGrid: 4,
                minuteGrid: 10,
                onClose: function(dateText, inst) {
                    var endDateTextBox = $('#samples_end');
                    if (endDateTextBox.val() != '') {
                        var testStartDate = new Date(dateText);
                        var testEndDate = new Date(endDateTextBox.val());
                        if (testStartDate > testEndDate)
                            endDateTextBox.val(dateText);
                    }
                    else {
                        endDateTextBox.val(dateText);
                    }
                },
                onSelect: function (selectedDateTime){
                    var start = $(this).datetimepicker('getDate');
                    $('#samples_end').datetimepicker('option', 'minDate', new Date(start.getTime()));
                }
            });

            $('#samples_end').datetimepicker({
                hourGrid: 4,
                minuteGrid: 10,
                onClose: function(dateText, inst) {
                    var startDateTextBox = $('#samples_start');
                    if (startDateTextBox.val() != '') {
                        var testStartDate = new Date(startDateTextBox.val());
                        var testEndDate = new Date(dateText);
                        if (testStartDate > testEndDate)
                            startDateTextBox.val(dateText);
                    }
                    else {
                        startDateTextBox.val(dateText);
                    }
                },
                onSelect: function (selectedDateTime){
                    var end = $(this).datetimepicker('getDate');
                    $('#samples_start').datetimepicker('option', 'maxDate', new Date(end.getTime()));
                }
            });
        }

        function getStartDate() {
            return $('#samples_start').datetimepicker('getDate');
        }

        function getEndDate() {
            return $('#samples_end').datetimepicker('getDate');
        }

        /* Get the samples */
        function ISODateString(d) {
            function pad(n){
                return n < 10 ? '0' + n : n
            }
            return d.getUTCFullYear() + '-'
            + pad(d.getUTCMonth() + 1) + '-'
            + pad(d.getUTCDate()) + 'T'
            + pad(d.getUTCHours()) + ':'
            + pad(d.getUTCMinutes()) + ':'
            + pad(d.getUTCSeconds()) + 'Z'
        }

        function findSamples(host, sampleKind, start, end) {
            var from = ISODateString(new Date(start));
            var to = ISODateString(new Date(end));
            $.ajax({
                url: "/rest/1.0/" + host + "/" + sampleKind + "?from=" + encodeURIComponent(from) + "&to=" + encodeURIComponent(to),
                dataType: "jsonp",
                cache : false,
                jsonp : "callback",
                jsonpCallback: "populateSamples"
            });
        }

        function populateSamples(payload) {
            payload = $.parseJSON(payload);
            // samples is an array in the form {memoryPoolUsed: "0,1,1,10,..."}, {ProcessCpuTime: "0,1,1,10,..."}
            var samples = payload.samples;
            for (var sampleKind in samples) {
                var csv = samples[sampleKind].split(",");
                // Build data in the form [{x:, y:}, {}, ...]
                var data = [];
                for (var i = 0; i < csv.length; i++) {
                    tmp = {x:0, y:0};
                    tmp.x = csv[i];
                    tmp.y = csv[i+1];
                    if (!isNaN(tmp.x) && !isNaN(tmp.y) && tmp.x.length > 0 && tmp.y.length > 0) {
                        data.push(tmp);
                    }
                    i++;
                }
                displayGraph(data, "#graphMiddle", 300, 300);
            }
        }

        /* Initialize the page */

        $(document).ready(function() {
            $('#loadingDiv')
                .hide()  // hide it initially
                .ajaxStart(function() {
                    $(this).show();
                })
                .ajaxStop(function() {
                    $(this).hide();
                });
            $('#errorDiv')
                .hide()  // hide it initially
                .ajaxError(function(event, request, settings) {
                    $(this).show();
                    $(this).append("<p>Error requesting " + settings.url + ", error is:" + request.responseText + "<p>");
                    event.preventDefault();
                });

            findHosts();
            findSampleKinds();
            setupDateTimePickers();

            // Retrieve user's preferences
            try {
                $("#host_name").val(localStorage.getItem("arecibo_latest_host_name_lookup"));
                $("#sample_kind").val(localStorage.getItem("arecibo_latest_sample_kind_lookup"));
                $("#samples_start").val(localStorage.getItem("arecibo_latest_samples_start_lookup"));
                $("#samples_end").val(localStorage.getItem("arecibo_latest_samples_end_lookup"));
            } catch (e) { /* Ignore quota issues, non supoprted Browsers, etc. */ }

            $("#crunch").click(function (event) {
                // Store locally the latest search
                var host_name_lookup = $("#host_name").val();
                var sample_kind_lookup = $("#sample_kind").val();
                var samples_start_lookup = $("#samples_start").val();
                var samples_end_lookup = $("#samples_end").val();
                try {
                    localStorage.setItem("arecibo_latest_host_name_lookup", host_name_lookup);
                    localStorage.setItem("arecibo_latest_sample_kind_lookup", sample_kind_lookup);
                    localStorage.setItem("arecibo_latest_samples_start_lookup", samples_start_lookup);
                    localStorage.setItem("arecibo_latest_samples_end_lookup", samples_end_lookup);
                } catch (e) { /* Ignore quota issues, non supoprted Browsers, etc. */ }

                findSamples(host_name_lookup, sample_kind_lookup, samples_start_lookup, samples_end_lookup);
                // Don't refresh the page
                event.preventDefault();
            });
        });
    </script>
</head>
<body>
    <div class="topbar">
      <div class="topbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/">Arecibo</a>
          <ul class="nav">
            <form action="">
                 <input type="text" class="medium" name="host_name" id="host_name" value="" placeholder="Hostname" />
            </form>
          </ul>
          <ul class="nav">
            <form action="">
                 <input type="text" class="xlarge" name="sample_kind" id="sample_kind" value="" placeholder="Sample kind" />
             </form>
          </ul>
          <ul class="nav">
            <form action="">
                <input type="text" class="medium" name="samples_start" id="samples_start" value="" placeholder="Start time" />
            </form>
          </ul>
          <ul class="nav">
            <form action="">
                <input type="text" class="medium" name="samples_end" id="samples_end" value="" placeholder="End time" />
            </form>
          </ul>
          <ul class="nav">
              <form action="">
                  <button class="btn small" id="crunch">Crunch!</button>
              </form>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" id="graphs-grid">
        <div class="content">
            <div class="page-header">
                <h1>Arecibo dashboard <small>prototype</small></h1>
                <div id="loadingDiv" class="alert-message info">
                    <p><strong>Be patient!</strong> Your data is loading...</p>
                </div>
                <div id="errorDiv" class="alert-message error">
                    <p><strong>Oh no!</strong></p>
                </div>
            </div>

            <div class="row show-grid" title="Arecibo Graphs">
                <div class="span-one-third" id="graphLeft"></div>
                <div class="span-one-third" id="graphMiddle"></div>
                <div class="span-one-third" id="graphRight"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
// Data: [{x:, y:}, {}, ...]
function displayGraph(data, id, width, height) {
    // Create an SVG element inside the div that fills 100% of the div
    var graph = d3.select(id).append("svg:svg").attr("width", "100%").attr("height", "100%");

    // X scale
    var x = d3.time.scale()
            .domain([d3.min(data, function(d) { return getDate(d.x); }), d3.max(data, function(d) { return getDate(d.x); })]) // Data minimum and maximum
            .range([0, width]); // The pixels to map to, e.g., the width of the diagram
    // Y scale
    var y = d3.scale.linear()
            .domain([d3.min(data, function(d) { return d.y; }), d3.max(data, function(d) { return d.y; })]) // Data minimum and maximum
            .range([0, height]); // The pixels to map to, e.g., the width of the diagram

    // Create a line object
    var line = d3.svg.line()
        // assign the X function to plot our line as we wish
        .x(function(d,i) { 
            //console.log('Plotting X value for data point: ' + d.x + ' using index: ' + i + ' to be at: ' + x(d.x) + ' using our xScale.');
            // return the X coordinate where we want to plot this datapoint
            return x(getDate(d.x)); 
        })
        .y(function(d, i) { 
            //console.log('Plotting Y value for data point: ' + d.y + ' using index: ' + i + ' to be at: ' + y(d.y) + ' using our yScale.');
            // return the Y coordinate where we want to plot this datapoint
            return height - y(d.y); 
        });

    // Create the graph with the line
    graph.selectAll("path")
        .data([data])
        .enter()
        .append("svg:path")
        .attr("class", "line")
        .attr("d", line);

    var rules = graph.selectAll("path.rule")
                 .data(x.ticks(3))
                 .enter().append("svg:g")
                 .attr("class", "rule");

    // Draw horizontal grid lines
    rules.append("svg:line")
         .attr("class", function(d) { return d ? null : "axis"; })
         .data(y.ticks(5))
         .attr("y1", function(d) { return height - y(d); })
         .attr("y2", function(d) { return height - y(d); })
         .attr("x1", 0)
         .attr("x2", width)
         .style("stroke", "#ccc")
         .style("stroke-width", 2);

    // Place Y axis ticks labels
    rules.append("svg:text")
         .attr("x", 0)
         .attr("y", function(d) { return height - y(d); })
         .attr("dx", -1)
         .attr("text-anchor", "end")
         .text(String);

    // Draw vertical grid lines
    rules.append("svg:line")
         .attr("x1", x)
         .attr("x2", x)
         .attr("y1", 0)
         .attr("y2", height - 1)
         .style("stroke", "#ccc")
         .style("stroke-width", 2);

    // Place X axis ticks labels
    rules.append("svg:text")
         .attr("x", x)
         .attr("y", height + 3)
         .attr("dy", ".71em")
         .attr("text-anchor", "middle")
         .text(x.tickFormat(10));
}

function getDate(d) {
    return new Date(d * 1000);
}
    </script>
</body>
</html>